{% extends D['_skn'] + 'page/my_dark/main_layout.html' %}

{% block contents_page  %}
<div class="row-row">
<div style="position:fixed;left:20px;top:30px;width:{{D['xwidth']}};background-color:#33363b;">
<br>
<div class="well clearfix">
    <form method='post' name='stock_back_testing' action="{{D['_bse']}}page/backtest/{{D['bid']}}" onsubmit='return check_thisForm()'>
    <div class="pull-left">
    <div class='select' style='margin-right:10px;vertical-align:bottom'>
        <input placeholder='종목코드' name='code' type='text' value="{{D['code']}}">
            <div class='btn-group'>
                <button class='btn btn-select dropdown-toggle' data-toggle='dropdown' tabindex='-1'><span class='caret'></span></button>
                    <ul class='dropdown-menu'>
                        <li><a>종목코드</a></li>
                        {% for cdx in D['sel_codes'] %}
                        <li><a href='#'>{{cdx}}</a></li>
                        {% endfor %}
                    </ul>
            </div>
    </div>
    <div class='select' style='margin-right:10px;vertical-align:bottom'>
        <input placeholder='매매전략' name='strategy' type='text' value="{{D['strategy']}}" style="width:170px">
            <div class='btn-group'>
                <button class='btn btn-select dropdown-toggle' data-toggle='dropdown' tabindex='-1'><span class='caret'></span></button>
                    <ul class='dropdown-menu'>
                        <li><a>매매전략</a></li>
                        {% for stg in D['sel_strategy'] %}
                        <li><a href='#'>{{stg}}</a></li>
                        {% endfor %}
                    </ul>
            </div>
    </div>
    <div class='i-input-div'>
        <div class='write-input-left' style="background-color:#333F4F;text-align:center;"> 초기 자본금</div>
        <input type='text' name='capital' class="i-number" style="width:80px;text-align:center;" value="{{D['capital']}}">
    </div>
    <div class='i-input-div'>
        <div class='write-input-left' style="background-color:#333F4F;text-align:center;"> 추가 자본금</div>
        <input type='text' class="i-number" name="addition" style="width:80px;text-align:center;" value="{{D['addition']}}">
    </div>
    <div class='i-input-div'>
        <div class='write-input-left' style="background-color:#333F4F;text-align:center;"> 초기 진행률</div>
        <input type='text' name="progress" style="width:60px;text-align:center;" value="{{D['progress']}}">
    </div>
    </div> <!--pull left-->
    <div class="pull-right">
    <div class='i-input-div'>
        <div class='write-input-left' style="background-color:#333F4F;text-align:center;"> 시작일자</div>
        <input type='text' name='start_date' class="i-date" value="{{D['start_date']}}" style="width:110px;text-align:center;">
    </div>
    <div class='i-input-div'>
        <div class='write-input-left' style="background-color:#333F4F;text-align:center;"> 종료일자</div>
        <input type='text' name='end_date' class="i-date" value="{{D['end_date']}}" style="width:110px;text-align:center;">
    </div>
    <button class="btn btn-red-s3" style="vertical-align:middle;">테스팅</button>
    </div> <!--pull right-->
    </form>
</div> <!--well-->
<div id="myChart2-div" class="clearfix" style="width:100%;background-color:#24272d;padding:10px;border:2px solid black;">
	<div>
		<canvas id="myChart2"  style="width:1460px;height:350px;background-color:#24272d;"></canvas>
	</div>
</div>

{% if D['NOTICE'] %}
<div style="padding:20px;font-size:24px;color:gray">{{D['NOTICE']}}</div>
{% else %}
	<div class="pull-left" style="padding:10px;color:lightgray">
	최대 일수 : <b>{{D['max_days']}}</b> 일 {{D['max_date']}} &nbsp;
	MDD : <b>{{D['MDD']}}</b> % {{D['MDD_DAY']}} &nbsp;
	전량매도 {{D['전량횟수']}} &nbsp; 전략매도 {{D['전략횟수']}} &nbsp;
	<i class="fa fa-arrow-up" onclick="chart_up_dn(1)"></i>
	<i class="fa fa-arrow-down" onclick="chart_up_dn(2)"></i>
	</div>
	<div class="pull-right" style="padding:10px;color:lightgray">
	{{D['output']|safe}}
	</div>
	<table class='table table-striped table-hover' style="width:{{D['xwidth']}};border:2px solid black;">
		<tr style="background-color:#393f4a;border-bottom:1px solid black">
			<th style='text-align:center;width:50px'>날수</th>
			<th style='text-align:right;width:60px'>진행</th>
			<th style='text-align:center;width:110px'>기록일자</th>
			<th style='text-align:right;width:80px'>종가</th>
			<th style='text-align:right;width:80px'>매수</th> 
			<th style='text-align:right;;width:100px'>매수금액</th>
			<th style='text-align:right;width:80px'>평균단가</th>
			<th style='text-align:right;width:60px'>매도</th>
			<th style='text-align:right;width:100px'>매도금액</th>
			<th style='text-align:right;width:100px'>진행상황</th>
			<th style='text-align:right;width:80px'>보유수량</th>
			<th style='text-align:right;width:100px'>총매수금</th>
			<th style='text-align:right;width:100px'>평가금액</th>
			<th style='text-align:right;width:100px'>수익현황</th>
			<th style='text-align:right;width:80px'>수익률%</th>
			<th style='text-align:right;width:80px'>일매수금</th>
			<th style='text-align:right;'>가용잔액</th>
		</tr>
	</table>
</div> <!--postion:fixed-->
</div> <!--rowrow clearfix-->

{% if D['TR'] %}
<div id="backTesting-table" class="row-row clearfix" style="margin-top:473px">
	
	<table class='table table-striped table-hover' style="border:2px solid black">
		<colgroup>
			<col style="width:50px;"> <!-- 날수 -->
			<col style="width:60px;"> <!-- 진행 -->
			<col style="width:110px;"> <!-- 일자 -->
			<col style="width:80px;background-color:#24272d;border:2px solid black;"> <!-- 당일종가 -->
			<col style="width:80px"> <!-- 매수 -->
			<col style="width:100px"> <!-- 매수금액 -->
			<col style="width:80px;background-color:#24272d;border:2px solid black;"> <!-- 평균단가 -->
			<col style="width:60px"> <!-- 매도 -->
			<col style="width:100px"> <!-- 거래코드 / 매도금액 -->
			<col style="width:100px"> <!-- 진행상황 -->
			<col style="width:80px"> <!-- 보유수량 -->
			<col style="width:100px"> <!-- 총매수금 -->
			<col style="width:100px"> <!-- 평가금액 -->
			<col style="width:100px"> <!-- 수익현황 -->
			<col style="width:80px"> <!-- 수익률 -->
			<col style="width:80px"> <!-- 일매수금 -->
			<col> <!-- 가용잔액 -->
		</colgroup>

		<tbody>
			{%- for TR in D['TR'] -%}
			{% if TR['가용잔액']|striptags == '전량매도'  %}
			<tr style="border-top:2px solid yellow;border-bottom:2px solid yellow;background-color:black;"> 
			{% elif TR['가용잔액'] == '손절매도' %}
			<tr style="border-top:2px solid #cef6ce;border-bottom:2px solid #cef6ce;background-color:black;"> 
			{% elif TR['가용잔액'] == '부분매도' %}
			<tr style="border-top:2px solid orange;border-bottom:2px solid orange;background-color:black;"> 
			{% elif TR['가용잔액']|striptags == '전략매도' %}
			<tr style="border-top:2px solid #A9D0F5;border-bottom:2px solid #A9D0F5;background-color:black;">
			{% else %}
			<tr>
			{% endif %}
				<td style='text-align:center'>{{TR['날수']}}</td>
				<td class='if-this-day'>{{TR['진행']}}</td>
				<td class='if-the-day'>{{TR['기록일자']}}</td>
				<td class='ohlc-price' style='text-align:right;cursor:pointer'>{{TR['당일종가']|safe}}</td>
				<td style='text-align:right'>{{TR['매수수량']}}</td>
				<td style='text-align:right'>{{TR['매수금액']}}</td>
				<td style='text-align:right;color:#F5F6CE'>{{TR['평균단가']|safe}}</td>
				<td style='text-align:right'>{{TR['매도수량']}}</td>
				<td style='text-align:right;color:#F6CECE'>{{TR['매도금액']}}</td>
				<td style='text-align:right'>{{TR['실현수익']|safe}}</td>
				<td style='text-align:right;color:#E6F8E0'>{{TR['보유수량']}}</td>
				<td style='text-align:right;color:#E0F8F7'>{{TR['총매수금']}}</td>
				<td style='text-align:right;color:#F8E6E0'>{{TR['평가금액']|safe}}</td>
				<td style='text-align:right'>{{TR['수익현황']|safe}}</td>
				<td style='text-align:right;font-weight:bold'>{{TR['수익률']|safe}}</td>
				<td style='text-align:right;font-weight:bold'>{{TR['일매수금']}}</td>
				<td style='text-align:right;color:#CEF6CE'>{{TR['가용잔액']|safe}}</td>
			</tr>
			{%- endfor %}
		</tbody>
	</table>
</div>
{% endif %}
{% endif %}

<div id='backTestingChart' style="position:fixed;left:20px;top:2170px;width:1420px;background-color:#24272d;padding:20px;border:2px solid black;">
	<canvas id="mybackTestChart" style="width:100%;height:280px;background-color:#24272d"></canvas>
</div>


<script src="/sys/chart/chart.min.js"></script>
<script>

// 챠트 객체 생성
const ctx = $id('mybackTestChart');
ctx.style.backgroundColor = '#33363b';
ctx.style.border = '2px solid black';

const labels = Array.from(new Array(10),(x,i)=> i+1);
const backData = {
	labels : labels,
	datasets : [
		{
			label:'당일종가',
			data : [2,5,6,3,8],
			borderColor:'#58ACFA', borderWidth:2,borderDash: [2,2], pointStyle:'circle', pointRadius:2, pointHoverRadius:15, backgroundColor:'#58ACFA',
			lineTension:0.2

		},
		{
			label:'평균단가',
			data : [3,6,7,8,5],
			pointStyle:'circle', borderWidth:4,pointRadius:2,pointHoverRadius:15,borderColor:'#f78181',backgroundColor:'#f78181',
			lineTension:0.2

		}
	]   
};
const options = {
	animation : {duration:0},
	plugins : { legend: {display:false} },
	responsive:false,
	layout:{padding:20},
	scales:{
		x:{ ticks : {color:'lightgray'}, grid:{color:'#272727'}},
		y:{ ticks : {color:'lightgray'}, grid:{color:'#272727'}}
	}
};
const config  = {type:'line',data:backData,options:options};
const myChart = new Chart(ctx, config);
// --------------------------------------------------------------------------------------


var selected_tr = null
$(document).ready(function(){ 
	$('#backTestingChart').bind('dblclick',function(){$(this).hide();}).draggable().hide();
	$(".if-the-day").click(function(){
		var date=$(this).text(); $("input[name='start_date']").val(date);
		var progress=$(this).prev().text(); $("input[name='progress']").val(progress);
	});

	$(".if-this-day").click(function(){
		if( selected_tr ) {	
			$(selected_tr).css("backgroundColor",'')
			h_dialog.close("TEST_DAY");
			h_dialog.close("TEST_IF25");
			h_dialog.close("TEST_IF50");
			h_dialog.close("TEST_IF75");
			selected_tr = null
		} else 
		{
			selected_tr = $(this).parent()
			$(selected_tr).css("backgroundColor","black")
			var date = $(this).next().text();
			var ypos= mouse_Y
			if(ypos > 800) ypos = ypos-280

			url = uri('linkurl') + 'page/test_theday/back_testing/date=' + date;
			o = {id:'TEST_DAY', width:'200px', x:240, y:ypos,header:false,footer:false,drag:false}
			h_dialog.load(url,o)

			var url = uri('linkurl') + 'page/test_if/back_testing/progress=25.0/date=' + date;
			var o = {id:'TEST_IF25', width:'260px', x:450, y:ypos,header:false,footer:false,drag:false}
			h_dialog.load(url,o);

			var url = uri('linkurl') + 'page/test_if/back_testing/progress=50.0/date=' + date;
			var o = {id:'TEST_IF50', width:'260px', x:720, y:ypos,header:false,footer:false,drag:false}
			h_dialog.load(url,o);

			var url = uri('linkurl') + 'page/test_if/back_testing/progress=75.0/date=' + date;
			var o = {id:'TEST_IF75', width:'260px', x:990, y:ypos,header:false,footer:false,drag:false}
			h_dialog.load(url,o);

		}
	});


	$(".ohlc-price").click(function(){
		if ($id("OHLC_DAY")) {h_dialog.close("OHLC_DAY"); return;}
		var code = $("input[name='code']").val()
		var date = $(this).prev().text();
		var url = uri('linkurl') + 'page/get_ohlc/back_testing/date=' + date + '/code=' + code;
		var ypos= mouse_Y
		if(ypos > 800) ypos = ypos-280
		var o = {id:'OHLC_DAY', width:'430px', x:323, y:ypos,header:false,footer:false,drag:false}
		h_dialog.load(url,o)		
	});

});	

function check_thisForm() {
    if(! $("input[name='code']").val() ) { h_dialog.notice("코드 입력은 필수입니다"); return false; }
	if(! $("input[name='strategy']").val() ) { h_dialog.notice("전략 입력은 필수입니다"); return false; }
    if(! $("input[name='capital']").val() ) { $("input[name='capital']").val('21,000') }  
	if(! $("input[name='addition']").val() ) { $("input[name='addition']").val('14,000') } 
    if(! $("input[name='start_date']").val() ) { h_dialog.notice("시작 일자가 입력되지않았습니다"); return false; }  
    if(! $("input[name='end_date']").val() ) { h_dialog.notice("종료 일자가 입력되지않았습니다"); return false; }  
    if($("input[name='start_date']").val() > $("input[name='end_date']").val() ) { h_dialog.notice("시작 일자는 종료일보다 커야 합니다"); return false; }
}

function show_chart(season) {
	$('#backTestingChart').css({top:'130px',left:'50px'}).show();
	var clsv = [];
	var avgv = [];

	$(".clsv"+season).each(function() {clsv.push(parseFloat($(this).text()))});
	$(".avgv"+season).each(function() {avgv.push(parseFloat($(this).text()))});
	
	var xticks = clsv.length
	if (xticks < 60 ) { xticks = 60; }
	var new_labels = Array.from(new Array(xticks),(x,i)=> i+1);
	avgv[avgv.length - 1] = avgv[avgv.length - 2]
	myChart.config.data.labels = new_labels;
	myChart.config.data.datasets[0].data =  clsv;
	myChart.config.data.datasets[1].data =  avgv;
	myChart.update();
}

// 본챠트 그리기
const ctx2 = $id('myChart2');
ctx2.style.backgroundColor = '#33363b';
ctx2.style.border = '2px solid black';

let labels2 = {{D['chart_date']|safe}};
const data2 = {
    labels : labels2,
    datasets : [
		{
            label:' 종가변동',
            data : {{D['close_price']|safe}},
			borderColor:'#58ACFA', borderWidth:2, pointRadius:0, borderDash:[2,3],
  			lineTension:0.2
    	},
		{
            label:' 평균단가',
            data : {{D['average_price']|safe}},
			borderColor:'#f78181', borderWidth:2, pointRadius:1,pointHoverRadius:24, backgroundColor:'#f78181',
			lineTension:0.2
        },
		{
            label:' 가치합계',
            data : {{D['total_value']|safe}},
            borderColor:'yellow', borderWidth:3,pointRadius:0, 
			lineTension:0.2,
			yAxisID : 'y1'
        },
    ]   
};
const options2 = {
	animation : { duration:1000	},
	plugins : { legend: {display:false}, tooltip:{enabled:false}},
    responsive:false,
    layout:{padding:20},
    scales:{
        x: { ticks : {color:'gray'}, grid:{color:'#272727'}},
        y: { ticks : {color:'gray'}, grid:{color:'#272727'},position:'left'},
		y1:{ type:'linear', display:true, position:'right'}
    }
};
const config2  = {type:'line',data:data2,options:options2};
const myChart2 = new Chart(ctx2, config2);


function chart_up_dn(opt) {
	if(opt==1) { $("#myChart2-div").hide(); $("#backTesting-table").css("marginTop",'100px'); }
	else {$("#myChart2-div").show(); $("#backTesting-table").css("marginTop",'473px');}
	// "margin-top:473px"
}
//
</script>
{% endblock %}
